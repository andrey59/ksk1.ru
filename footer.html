<!--Общий подвал-->

<script type="application/javascript">

/**
 * Load Javascript asynchronously and execute callback on success
 * @param src {string} Script URL
 * @param onload {function} Callback to call on success
 */
function LoadJS(src, onload) {
//        if (typeof(L) == "undefined") {
//            window.L = "loading";
    var a = document.createElement("script");
    a.type = "text/javascript";
    a.src = src;
    if (typeof (onload) == "function")
        a.onload = onload;
    a.onerror = function () {
//                delete L;
        console.log("Error loading " + src)
    };
    document.getElementsByTagName("head")[0].appendChild(a);
//        }
}

function LoadCSS(src) {
    var a = document.createElement("script");
    a.rel = "stylesheet";
    a.type = "text/css";
    a.href = src;
    a.onerror = function () {
        console.log("Error loading " + src)
    };
    document.getElementsByTagName("head")[0].appendChild(a);
}


    //    // TabDrop
    //    if (window['operamini']) {
    //        jQuery('.nav-pills').css("max-height", "none");
    //    } else {
    //        jQuery('.nav-pills').tabdrop({text: '<i class="fa fa-align-justify"></i> Ещё'});
    //    }

    // Подгоняем высоту карты
    function setMapHeight() {
        //FIXME: Не устанавливать высоту для мобильных устройств!
        jQuery('.navpanel-info > .subpanel').not('.panel-map').each(function () {
            var this_height = jQuery(this).height();
            var panel_map = jQuery('.panel-map');
            if (this_height > panel_map.height()) {
                var panel_map_map = jQuery('#panel-map');
                panel_map_map.css('height', this_height - (panel_map_map.offset().top - panel_map.offset().top));
            }
        });
        //FIXME: Надо уведомить leaflet, что его высота поменялась
    }

    jQuery('.triggers-weather').click(function () {
        jQuery('#btn-feature-info').click();
    });

    jQuery('.btn-feature').click(function () {
        was_active = jQuery(this).hasClass('active');
        potential_cond_active = jQuery('.potential-cond-active');
        jQuery('.navpanel, .btn-feature').removeClass('active');
        potential_cond_active.removeClass('cond-active');
        if (!was_active) {
            jQuery(this).addClass('active');
            target_navpanel = jQuery('.' + jQuery(this)[0].id.replace('btn-feature', 'navpanel'));
            target_navpanel.addClass('active').trigger('first-load');
        } else {
            potential_cond_active.addClass('cond-active');
        }
    });

    jQuery('#navpanel-info').on('first-load', function () {

        // загружаем кнопку категории вместо кнопки другие категории
        jQuery("#category-other").load("http://ksk1.ru/cat-menu.html");

        // Загружаем афишу
        jQuery("#panel-agenda").load("http://news.kskmedia.ru/agenda-block/", function () {
            setMapHeight();
            jQuery('.movie-poster').each(function (element) {
                jQuery(this).popover({
                    content: jQuery('#content-' + jQuery(this)[0].id).html(),
                    html: true,
                    placement: "bottom",
                    trigger: 'hover',
                    container: '.today-movies-margin',
                    viewport: 'body'
                });
            });
        });

        // Загружаем карту
        setMapHeight();

        // TODO: загружать локальный leaflet
        LoadJS( 'http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js', LeafletInit );
        LoadCSS('http://ksk1.ru/vendor/leaflet/dist/leaflet.css' );
        LoadCSS('http://ksk1.ru/vendor/leaflet-addon.css' );

        function LeafletInit (){

            var map = L.map('panel-map');
            map.setView([56.6132, 57.7689], 13);
            var OpenMapSurfer_Roads = L.tileLayer('http://openmapsurfer.uni-hd.de/tiles/roads/x={x}&y={y}&z={z}', {
                minZoom: 0,
                maxZoom: 20,
                attribution: 'Карта: <a href="http://openstreetmap.org">OpenStreetMap</a>, плитки: <a href="http://giscience.uni-hd.de/">GIScience</a>'
            });
            OpenMapSurfer_Roads.addTo(map);

            LoadJS( 'http://ksk1.ru/vendor/leaflet-geosearch/src/js/l.control.geosearch.js', LeafletAddSearch );
        }

        function LeafletAddSearch (){
            L.GeoSearch.Provider.OpenStreetMapKsk = L.Class.extend({
                options: { },
                initialize: function (options) {
                    options = L.Util.setOptions(this, options);
                },
                /**
                 * @return {string}
                 */
                GetServiceUrl: function (qry) {
                    var parameters = L.Util.extend({
                        q: "Красноуфимск " + qry,
                        format: 'json'
                    }, this.options);
                    return 'http://nominatim.openstreetmap.org/search'+ L.Util.getParamString(parameters);
                },
                ParseJSON: function (data) {
                    if (data.length == 0)
                        return [];
                    var results = [];
                    for (var i = 0; i < data.length; i++)
                        results.push(new L.GeoSearch.Result( data[i].lon, data[i].lat, data[i].display_name ));
                    return results;
                }
            });

            new L.Control.GeoSearch({
                provider: new L.GeoSearch.Provider.OpenStreetMapKsk(),
                country: 'ru',
                searchLabel: 'Найти на карте…',
                notFoundMessage: 'К сожалению, ничего не найдено',
                zoomLevel: 17
            }).addTo(map);
        }

        // Отключаемся от события
        jQuery(this).unbind('first-load');
    });


    jQuery('.btn-collapse').click(function () {
        jQuery('.navpanel, .btn-feature').removeClass('active');
        jQuery('.potential-cond-active').addClass('cond-active');
    });

    // Поисковая строка
    (function () {
        var meta_generator = jQuery("meta[name='generator']").attr("content");
        if (meta_generator && meta_generator.substring(0, 9) == "WordPress") {
            // Пусто. У сайтов на WordPress свой поиск
        } else {

            var cx;
            var url = document.location.href;
            if (url.match(/^[http:\/\/]+ob/)) { // Поиск по объявлениям
                cx = '003704283744183876190:qchgmzsmjkc';
            } else { // Поиск по новостям
                cx = '003704283744183876190:woiuqgnl_eg';
            }
            var gcse = document.createElement('script');
            gcse.type = 'text/javascript';
            gcse.async = true;
            gcse.src = '//www.google.com/cse/cse.js?cx=' + cx;
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(gcse, s);
        }
    })();

    // Alt-режим
    var time = null;
    document.onkeydown = function (e) {
        e = e || window.event;
        if (e.keyCode === 17)
            if (((+new Date) - time) < 400) {
                jQuery('body').toggleClass('alt');
                time = null;
            } else {
                time = +new Date;
            }
    };

    //  Openstat
    var openstat = { counter: 2173092, image: 5041, next: openstat };
    (function () {
        var j = document.createElement("script");
        j.async = true;
        j.type = "text/javascript";
        j.src = "//openstat.net/cnt.js";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(j, s);
    })();


    // Yandex.Metrika counter
    /*    (function (d, w, c) {
     (w[c] = w[c] || []).push(function () {
     try {
     w.yaCounter5036764 = new Ya.Metrika({id: 5036764,
     webvisor: true,
     clickmap: true,
     trackLinks: true,
     accurateTrackBounce: true});
     } catch (e) {
     }
     });
     var n = d.getElementsByTagName("script")[0],
     s = d.createElement("script"),
     f = function () {
     n.parentNode.insertBefore(s, n);
     };
     s.type = "text/javascript";
     s.async = true;
     s.src = "//mc.yandex.ru/metrika/watch.js";
     if (w.opera == "[object Opera]") {
     d.addEventListener("DOMContentLoaded", f, false);
     } else {
     f();
     }
     })(document, window, "yandex_metrika_callbacks");
     */

</script>
<noscript><img src="//mc.yandex.ru/watch/5036764" style="position:absolute; left:-9999px;" alt=""/></noscript>


<!-- Gismeteo informer START -->
<div class="popover-source-gismeteo">
    <div id="gsInformerID-5yW5CsFg4TLIH3" class="gsInformer" style="width:300px;height:157px">
        <div class="gsIContent">
            <div id="cityLink">
                <a href="http://www.gismeteo.ru/city/daily/4515/" target="_blank">Погода в Красноуфимске</a>
            </div>
            <div class="gsLinks">
                <table>
                    <tr>
                        <td>
                            <div class="leftCol">
                                <a href="http://www.gismeteo.ru" target="_blank">
                                    <img alt="Gismeteo" title="Gismeteo"
                                         src="http://www.gismeteo.ru/static/images/informer2/logo-mini2.png"
                                         align="absmiddle" border="0"/>
                                    <span>Gismeteo</span>
                                </a>
                            </div>
                            <div class="rightCol">
                                <a href="http://www.gismeteo.ru/city/weekly/4515/" target="_blank">Прогноз на 2
                                    недели</a>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>
<script src="http://www.gismeteo.ru/ajax/getInformer/?hash=5yW5CsFg4TLIH3" type="text/javascript"></script>
<script type="text/javascript">
    jQuery(window).load(function () {
        // Popover для погоды с блоком от Гисметео
//        jQuery('.weather-block-col, .weather-temp-sm').popover({
//            content: jQuery('.popover-source-gismeteo').html(),
//            html: true,
//            placement: "bottom"
//        });
        jQuery('#weather-panel').html(jQuery('.popover-source-gismeteo').html());
        if (jQuery(window).width() < 765) {
            jQuery("#vote_xs").html(jQuery("#panel-vote-xs").html());
            jQuery("#panel-vote-xs").remove();
        }
    });
</script>
<!-- Gismeteo informer END -->


<footer class="visible-print text-right">
    <em>Информация с сайта <span style="text-decoration: underline;">ksk66.ru</span>.
        При использовании материалов ссылка обязательна.</em>
</footer>
<footer class="hidden-print" style="margin-top:20px;">
    <div class="row">
        <div class="col-sm-6" style="text-align:right;">
            <h3>18+ © 2008-2015 Красноуфимск Онлайн</h3>

            <p class="footer_registration">Свидетельство о регистрации СМИ Эл № ФС 77-42292 от 30.09.2010 г., выдано
                Федеральной службой по надзору в сфере связи, информационных технологий и массовых коммуникаций.</p>

            <p class="footer_backlinks">При использовании материалов сайта ссылка обязательна.</p>

            <p class="footer_opinion">Мнение редакции может не совпадать с мнением авторов материалов и
                комментариев.</p>

            <div>
                <span id="openstat2173092"></span>
                <span><a href="http://rating.openstat.ru/site/2173092">Статистика посещений</a></span> •
                <span><a href="http://ob.ksk66.ru/p11.html">Правила сайта</a></span> •
                <span><a href="http://news.kskmedia.ru/reklama-site/">Реклама на сайте</a></span>
            </div>
        </div>
        <div class="col-sm-6 footer-contacts">
            <h5>Связаться с нами:</h5>

            <h3><a class="footer-tel" href="tel:+73439479710">8 (34394) <strong>7-97-10</strong></a><br>
                <a class="footer-email" href="mailto:infotek66@gmail.com">infotek66@gmail.com</a></h3>
            <h4 class="footer-feedback"><a href="http://news.kskmedia.ru/mail/">Форма обратной связи</a></h4>
            <h4 class="footer-address">Свердловская обл., г. Красноуфимск, ул. Ленина, д. 88</h4>
        </div>
    </div>
</footer>


<!-- Кнопка «Наверх» -->
<!--suppress HtmlUnknownAnchorTarget -->
<a href="#header" onclick="jQuery('html,body').animate({ scrollTop: 0 }, 'slow'); jQuery(this).blur(); return false;"
   class="btn-home inactive text-center">
    <i class="fa fa-angle-up fa-5x"></i>

    <div style="position:relative; top:-15px;">
        НАВЕРХ
    </div>
</a>
<script>
    var offset = 1000;
    if (jQuery('.btn-scroll-up').length) {
        jQuery('.btn-home').remove();
    } else {
        jQuery(window).scroll(function () {
            if (jQuery(this).scrollTop() > offset) {
                jQuery('.btn-home').removeClass("inactive");
            } else {
                jQuery('.btn-home').addClass("inactive");
            }
        });
    }
</script>

<script>
    var $buoop = { text: "Ваш браузер (%s) <b>устарел</b>. В нём могут быть <b>уязвимости</b> и он <b>не показывает все возможности</b> этого и других сайтов. \
<a%s>Узнайте, как обновить ваш браузер</a>" };
</script>
<script src="//browser-update.org/update.js"></script>
